<?php

namespace Rekhyt\PhpDependencyChecker\Test\Vulnerability\Repository\SLApi;

use GuzzleHttp\Client;
use Rekhyt\PhpDependencyChecker\Vulnerability\Repository\SLApi\Vulnerability;
use Rekhyt\PhpDependencyChecker\Vulnerability\ValueObject\ApiEndpoint;
use Rekhyt\PhpDependencyChecker\Vulnerability\ValueObject\ComposerLockFileContents;

class VulnerabilityTest extends \PHPUnit_Framework_TestCase
{
    /** @var Vulnerability */
    private $subjectUnderTest;

    /** @var Client */
    private $client;

    public function setUp()
    {
        $this->client           = new Client();
        $this->subjectUnderTest = new Vulnerability(
            $this->client,
            new ApiEndpoint('https://security.sensiolabs.org/check_lock')
        );
    }

    public function testDefaultEndpointIsReachable()
    {
        $response = $this->subjectUnderTest->getAllByComposerLockFileContents(
            new ComposerLockFileContents(file_get_contents(__DIR__ . '/../../../../fixtures/composer-secure.lock.json'))
        );

        $this->assertEquals([], $response);
    }

    public function testKnownVulnerabilityIsFound()
    {
        $response = $this->subjectUnderTest->getAllByComposerLockFileContents(
            new ComposerLockFileContents(file_get_contents(__DIR__ . '/../../../../fixtures/composer-vulnerable.lock.json'))
        );

        $this->assertNotEmpty($response);
    }
}